{% extends "base.html" %}

{% block title %}NLP Analysis Results{% endblock %}

{% block extra_css %}
<style>
    .entity {
        background-color: #ffeb3b;
        padding: 2px 4px;
        border-radius: 3px;
        border: 1px solid #ffc107;
        font-weight: bold;
        margin: 0 1px;
    }
    .entity-highlight {
        line-height: 1.6;
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
    }
    .stat-card {
        text-align: center;
        padding: 1rem;
    }
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    /* Entity type colors */
    .entity-PERSON { background-color: #e1bee7; border-color: #ba68c8; }
    .entity-ORG { background-color: #bbdefb; border-color: #64b5f6; }
    .entity-PRODUCT { background-color: #c8e6c9; border-color: #81c784; }
    .entity-GPE { background-color: #ffccbc; border-color: #ff8a65; }
    .entity-MONEY { background-color: #fff9c4; border-color: #fff176; }
    .entity-CUSTOM_PRODUCT { background-color: #d1c4e9; border-color: #9575cd; }
    
    .badge.entity-PERSON { background-color: #e1bee7; color: #4a148c; }
    .badge.entity-ORG { background-color: #bbdefb; color: #0d47a1; }
    .badge.entity-PRODUCT { background-color: #c8e6c9; color: #1b5e20; }
    .badge.entity-GPE { background-color: #ffccbc; color: #bf360c; }
    .badge.entity-MONEY { background-color: #fff9c4; color: #f57f17; }
    .badge.entity-CUSTOM_PRODUCT { background-color: #d1c4e9; color: #4a148c; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-primary">
                <i class="bi bi-graph-up"></i> NLP Analysis Results
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('task3.nlp_input') }}">Task 3</a></li>
                    <li class="breadcrumb-item active">Results</li>
                </ol>
            </nav>
        </div>
    </div>

    {% if analysis %}
    <!-- Single Text Analysis Results -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-chat-text"></i> Text Analysis Results
            </h5>
        </div>
        <div class="card-body">
            <!-- Original Text -->
            <div class="mb-4">
                <h6 class="fw-semibold">
                    <i class="bi bi-text-paragraph"></i> Original Text:
                </h6>
                <div class="border p-3 bg-light rounded">
                    <p class="mb-0">{{ analysis.original_text }}</p>
                </div>
            </div>

            <div class="row g-4">
                <!-- Sentiment Analysis -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-emoji-smile"></i> Sentiment Analysis
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <span class="badge {% if analysis.sentiment.final_sentiment == 'positive' %}bg-success
                                {% elif analysis.sentiment.final_sentiment == 'negative' %}bg-danger
                                {% else %}bg-secondary{% endif %} fs-5 p-2">
                                    {{ analysis.sentiment.final_sentiment|upper }}
                                </span>
                            </div>

                            <div class="mb-3">
                                <h6>Rule-Based Analysis:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Sentiment:</strong></td>
                                            <td>{{ analysis.sentiment.rule_based.sentiment }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Score:</strong></td>
                                            <td>{{ "%.3f"|format(analysis.sentiment.rule_based.score) }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Positive Words:</strong></td>
                                            <td>{{ analysis.sentiment.rule_based.positive_words }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Negative Words:</strong></td>
                                            <td>{{ analysis.sentiment.rule_based.negative_words }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <div>
                                <h6>TextBlob Analysis:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Sentiment:</strong></td>
                                            <td>{{ analysis.sentiment.textblob.sentiment }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Polarity:</strong></td>
                                            <td>{{ "%.3f"|format(analysis.sentiment.textblob.polarity) }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Subjectivity:</strong></td>
                                            <td>{{ "%.3f"|format(analysis.sentiment.textblob.subjectivity) }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Named Entity Recognition -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-tags"></i> Named Entity Recognition
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <span class="badge bg-info fs-5 p-2">
                                    {{ analysis.entity_summary.total_entities }} Entities Found
                                </span>
                            </div>

                            {% for entity_type, entities_list in analysis.entities.items() %}
                                {% if entities_list %}
                                <div class="mb-3">
                                    <strong class="text-primary">{{ entity_type }}</strong> 
                                    <span class="badge bg-secondary">{{ entities_list|length }}</span>
                                    <div class="mt-1">
                                        {% for entity in entities_list %}
                                            <span class="badge entity-{{ entity_type }} me-1 mb-1">
                                                {{ entity.text }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Highlighted Text -->
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="bi bi-highlighter"></i> Text with Highlighted Entities
            </h5>
        </div>
        <div class="card-body">
            <div class="entity-highlight">
                {% set text = analysis.cleaned_text %}
                {% set entities = [] %}
                
                {% for entity_type, entity_list in analysis.entities.items() %}
                    {% for entity in entity_list %}
                        {% set _ = entities.append(entity) %}
                    {% endfor %}
                {% endfor %}
                
                {% set entities = entities|sort(attribute='start') %}
                {% set last_end = 0 %}
                {% set highlighted_parts = [] %}
                
                {% for entity in entities %}
                    {% if entity.start > last_end %}
                        {% set _ = highlighted_parts.append({'text': text[last_end:entity.start], 'type': None}) %}
                    {% endif %}
                    {% set _ = highlighted_parts.append({'text': text[entity.start:entity.end], 'type': entity.label}) %}
                    {% set last_end = entity.end %}
                {% endfor %}
                
                {% if last_end < len(text) %}
                    {% set _ = highlighted_parts.append({'text': text[last_end:], 'type': None}) %}
                {% endif %}
                
                {% for part in highlighted_parts %}
                    {% if part.type %}
                        <span class="entity entity-{{ part.type }}" 
                              data-bs-toggle="tooltip" 
                              title="{{ part.type }}">
                            {{ part.text }}
                        </span>
                    {% else %}
                        {{ part.text }}
                    {% endif %}
                {% endfor %}
            </div>
            
            <div class="mt-3">
                <small class="text-muted"><strong>Entity Legend:</strong></small>
                {% for entity_type in analysis.entities.keys() %}
                    <span class="badge entity-{{ entity_type }} me-1">{{ entity_type }}</span>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Text Statistics -->
    <div class="card mb-4 border-secondary">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">
                <i class="bi bi-bar-chart"></i> Text Statistics
            </h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-number text-primary">{{ analysis.analysis_metadata.text_length }}</div>
                        <p class="text-muted mb-0">Characters</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-number text-success">{{ analysis.analysis_metadata.cleaned_length }}</div>
                        <p class="text-muted mb-0">Cleaned Characters</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-number text-info">{{ analysis.analysis_metadata.entity_count }}</div>
                        <p class="text-muted mb-0">Entities Found</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% elif batch_analysis %}
    <!-- Batch Analysis Results -->
    <div class="card border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="bi bi-table"></i> Batch Analysis Results ({{ batch_analysis.sample_size }} reviews)
            </h5>
        </div>
        <div class="card-body">
            <p class="mb-3">
                <i class="bi bi-database"></i> 
                Analyzed {{ batch_analysis.sample_analyses|length }} reviews from: 
                <code>{{ batch_analysis.file_path }}</code>
            </p>
            
            {% for analysis in batch_analysis.sample_analyses %}
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Review {{ loop.index }}</h6>
                    <div>
                        <span class="badge {% if analysis.sentiment.final_sentiment == 'positive' %}bg-success
                        {% elif analysis.sentiment.final_sentiment == 'negative' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                            {{ analysis.sentiment.final_sentiment|upper }}
                        </span>
                        <span class="badge bg-primary">Entities: {{ analysis.entity_summary.total_entities }}</span>
                        {% if analysis.label %}
                        <span class="badge bg-warning text-dark">Label: {{ analysis.label }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">
                        {{ analysis.original_text[:200] }}{% if analysis.original_text|length > 200 %}...{% endif %}
                    </p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <strong><i class="bi bi-tags"></i> Entities:</strong>
                            {% for entity_type, entities_list in analysis.entities.items() %}
                                {% if entities_list %}
                                <div class="mt-1">
                                    <small>
                                        <strong>{{ entity_type }}:</strong>
                                        {% for entity in entities_list %}
                                            <span class="badge bg-light text-dark me-1">{{ entity.text }}</span>
                                        {% endfor %}
                                    </small>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="col-md-6">
                            <strong><i class="bi bi-emoji-smile"></i> Sentiment:</strong>
                            <ul class="small list-unstyled mt-1">
                                <li><strong>Final:</strong> {{ analysis.sentiment.final_sentiment }}</li>
                                <li><strong>Rule-based:</strong> {{ analysis.sentiment.rule_based.sentiment }}</li>
                                <li><strong>TextBlob:</strong> {{ analysis.sentiment.textblob.sentiment }}</li>
                                <li><strong>Positive words:</strong> {{ analysis.sentiment.rule_based.positive_words }}</li>
                                <li><strong>Negative words:</strong> {{ analysis.sentiment.rule_based.negative_words }}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="mt-4 text-center">
        <a href="{{ url_for('task3.nlp_input') }}" class="btn btn-primary btn-lg me-2">
            <i class="bi bi-arrow-repeat"></i> Analyze Another Text
        </a>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-lg">
            <i class="bi bi-house"></i> Back to Home
        </a>
    </div>
</div>

<script>
// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
});
</script>
{% endblock %}